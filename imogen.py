from commands import *
import acorn
acorn.bbc()

config.set_label_references(False)

constant(21, "vdu_disable")
constant(22, "vdu_set_mode")
constant(31, "vdu_goto_xy")
constant(0xffdd, "osfile")
constant(24, "game_area_height_cells")
constant(0x20, "jsr_opcode")
constant(0x6c, "jmp_indirect_opcode")

# This code is loaded at &3900 at the end of the BASIC loader, but it is relocated down to &1200.
# It's cleaner for the disassembly to pretend it's just loaded directly at &1200.
load(0x1200, "orig/imogen-trailing-mc-3900.dat", "6502", "db128cdc10469437ae5852336e5ff818")

label(0x0070, "source_address_low")
label(0x0071, "source_address_high")
label(0x0072, "destination_address_low")
label(0x0073, "destination_address_high")

entry(0x1200)
label(0x1200, "relocate_address")
label(0x1200, "relocate")
expr(0x1207, make_hi("relocate_address"))
expr(0x120b, make_hi("load_address"))
label(0x1210, "relocate_loop")
expr(0x121e, make_hi(make_add("load_address", make_subtract("pydis_end", "pydis_start"))))
label(0x1234, "post_relocate_init")
comment(0x123d, "Redundant LDX/LDY here; drive_0_command is not actually used.")
expr(0x123e, make_lo("drive_0_command"))
expr(0x1240, make_hi("drive_0_command"))
comment(0x1241, "*DIR $")
expr(0x1242, make_lo("dir_dollar_command"))
expr(0x1244, make_hi("dir_dollar_command"))
comment(0x1248, "*FX 200,1")
comment(0x1251, "Read the user's current vertical shift as set by *TV.")
comment(0x125f, "MODE 4")
expr(0x1260, "vdu_set_mode")
comment(0x1261, "Set up a reduced-height mode 4 screen with 24 character lines starting at address &6200, respecting the user's current vertical shift as set by *TV.")
expr(0x128a, make_lo(make_divide("screen_start", 8)))
expr(0x1294, make_hi(make_divide("screen_start", 8)))
expr(0x129e, "game_area_height_cells")
comment(0x12ac, "wait")
decimal(0x12ad)
comment(0x12b1, "copy $800 bytes of memory from $1368 to $67C0, which copies the big IMOGEN logo to the screen. It starts $80 bytes before it should obviously do, perhaps as obfuscation.")
label(0x12d1, "copy_loop")
expr(0x12e0, "vdu_goto_xy")
label(0x12f0, "print_written_by_string_loop")
label(0x12fe, "finished_written_by_string")
comment(0x12fe, "PRINT TAB(3,23)")
expr(0x12ff, "vdu_goto_xy")

label(0x130f, "print_copyright_string_loop")
label(0x131d, "finished_copyright_string")
expr(0x131e, "vdu_disable")
comment(0x1322, "Obfuscated code to load the 'G' file and transfer control to its execution address, relying on the fact that OSFILE &FF will have filled in the execution address at &76 after loading the file.")
comment(0x1322, "At address zero, write 'JSR osfile:JMP ($76)'")
expr(0x1323, "jsr_opcode")
expr(0x1327, make_lo("osfile"))
expr(0x132b, make_hi("osfile"))
expr(0x132f, "jmp_indirect_opcode")
comment(0x133a, "point to filename")
expr(0x133b, make_lo("osfile_load_filename"))
expr(0x133f, make_hi("osfile_load_filename"))
comment(0x1342, "Set A=&FF for OSFILE to load a file. We also store this at &76, which is byte 6 of the control block, telling OSFILE to load at the file's own load address.")
expr(0x1347, make_lo("source_address_low"))
expr(0x1349, make_hi("source_address_low"))
label(0x134d, "print_italic")
comment(0x135b, "read character definition")
comment(0x1364, "shift the rows of the character definition to italicise it")
comment(0x136e, "redefine character 255 to the italicised character")
label(0x137a, "print_italic_loop")
label(0x138a, "print_character")
label(0x138d, "drive_0_command")
label(0x1395, "dir_dollar_command")
label(0x139b, "wait_for_a_vsyncs")
label(0x139d, "wait_loop")
label(0x13a7, "osfile_load_filename")
stringcr(0x13a7)
label(0x13a9, "written_by_string")
label(0x13c5, "copyright_string")
label(0x13e8, "imogen_logo")
byte(0x13e8, 0x800-0x80)
#picture_binary(0x13e8, 0x800-0x80)
comment(0x1b68, "unused?")

label(0x3900, "load_address")
label(0x6200, "screen_start")

go()

# vi: tw=100

# Local Variables:
# fill-column: 100
# End:
